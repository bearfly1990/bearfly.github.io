---
layout:     post
title:      Multi-parameters performance test
subtitle:   Thinking about how to set up the next multi-parameters test
date:       2018-06-14
author:     BF
header-img: img/bf/earth_1.jpg
catalog: true
tags:
    - performance
    - test
    - goal
---
# Multi-variables performance test
最近一直在忙，都没有时间总结和改进现在的测试流程，瓶颈已经显现出来。下周的一个主要的任务就是大批量的测试不同虚拟机下不同参数执行任务的性能,从而得到CPU和Memory消耗适合的一些参数，并做为benchmark。可以预见之后还有类似的测试的任务，那必要要提前做好改变。今天主要是把思路整理出来。

## 背景与需求
之前已经有经过多次改良的脚本，可以执行在一个虚拟机上的完整测试任务，针对不同的机器，都有对应的配置文件。当测试流程开始时，会读取对应的配置，而且这些配置都是存放在Share Folder下对应的机器名文件夹下，那么每次测试之前，都需要手动去把对应的文件改成要想要的数据（主要就2个配置文件），然后执行任务，结束之后会有对应的Test Result和Monitor Data以供收集数据。

那么，接下来想要实现的就是**一次性配置**多个参数，不同的机器能够自动依次执行测试任务，最后将所有的测试结果合在一处，形成报表，而不再需要人工再去采集一下。

## 实现思路
### 数据库
目前DB需要人工去回滚，因为之前数据库资源紧张，经常需要去切换。如果写在代码中，容易失误而restore错数据库，所以用sql人工去执行回滚，当时为适合的方案。那么接下来要自动连续测试的话，首先第一步就是把自动回滚加入到每次测试用例执行前。

需要考虑的是使用什么方式：
* 可以直接用目前的python去写回滚脚本，并加入到整体流程代码中。
* 可以先用Powershell或Python写一个独立的回滚脚本，并可以加入系统Scheduler中，而主程序只是调用，这样可以将回滚任务分离。比如具体的DB信息，回滚基于的Backup都不需要在主程序中设置。我比较偏向这个选择，这样回滚数据库功能更容易共享，可以给别的测试任务使用。

### 配置文件
原来的流程中是去基于机器名目录下去寻找固定名字的配置文件(e.g. config.ini)。那么现在必须增加配置选择，也有几种方案：
首先必要的是新增变量组合的配置，这个可以放在主程序配置中，也可以在Share Folder下单独配置e.g. VM_Name/parameters.ini 类似于
```ini
[TC1]
configfile1.key1 = value1
configfile2.key2 = value2
[TC2]
configfile1.key1 = value3
configfile2.key2 = value4
...
```
而在上面的前提下：
* 在VM名目录下按变量顺序新加文件夹，e.g. V1_V2/config.ini,引导主程序使用该目录下的配置。
* 建立一个config.ini模板，比如VM_Name/config.template.ini，然后将读取后的配置填充进去，每次都生成新的VM_Name/config.ini。这样的话，原来的主程序并不需要改变，只需要把新功能添加进去就好，而且之前写过类似的，可以拿来复用，我偏向这个方式。

### 多台虚拟机信息交互
上面想通了，基本上一台机器的自动多次任务执行就没有什么问题了，主要是去实现。但现在涉及到不同机器之前先后执行顺序，一台执行完需要另一台机器接着做。

之前做过一个类似的，大体思路可以拿来用:

1. 将不同机器中的主程序加入Scheduler中
2. 建立一个入口批处理bat，在其中先后调用不同VM中的Scheduler去执行主程
3. 每次触发一个Scheduler运行之后利用timeout等方式等待(所以Delay时间必须要大于前一个所有test都完成的时间，不然会有conflict)

前面`3`的改进版本：
* 死等固定时间肯定是很不明智的，尤其是在消耗时间不明确的情况下，这样效率非常低。那么这个时候，在每个主程序中加入一个操作，就是在每次轮到自己执行的时候，就会在一个share folder下生成一个信息文件表示自己开始执行号，这样在接下来的VM要执行的时候就会block住，等待上一个机器完成的信息，之后再继续自己执行

其实，现在的job benchmark就是用类似的思路。

### 最后，TestResult
目前，每台机上跑的时候都会在本机生成以时间为名字的目录，并将该次的TestResult生成在该目录下。那么接下来的目标是：
* 生成结果统一生成到Share Folder，这样方便管理，而且大家都能看到。
* 生成结果统一放在一个目录日期目录下，之后再以每台机器自己的名字为目录，再在每台机子下用参数值做目录，最后的Result就放在这个目录下。
* optional:将所以的结果统一个Excel文件中，放在root目录下，这样每轮跑完就可以直接查看结果。

## 结尾，晚安！






